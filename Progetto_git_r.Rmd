---
title: "Esplorazione dataset sul bikesharing a Washington D.C. fra il 2011 e 2012"
author: "Gianluca La Malfa"
date: 'Venezia, Luglio 2022'
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

=========================================

#Introduzione
Questo progetto rappresenta l'elaborato finale del corso 'Dati e Conoscenza' nell'ambito del Minor in Computer and Data science all'università Ca'Foscari di Venezia.
Il dataset utilizzato riguarda una azienda di bike sharing e una agenzia meteo fra il 2011 e il 2012 a Washington D.C. Vi troviamo dati sulla quantità di biciclette date in noleggio e i rispettivi dati sul meteo con una granularità giornaliera.

## Obbiettivi del progetto:
In questo documento si cercherà di analizzare i dati per comprendere al meglio il dataset. Per poi svolgere una analisi di regressione per verificare il grado di correlazione fra la temmmperatura e il numero di biciclette noleggiate dall'azienda di bike sharing.

##Descrizione dataset:

	- instant: record index
	- dteday : date
	- season : season (1:springer, 2:summer, 3:fall, 4:winter)
	- yr : year (0: 2011, 1:2012)
	- mnth : month ( 1 to 12)
	- hr : hour (0 to 23)
	- holiday : weather day is holiday or not (extracted from http://dchr.dc.gov/page/holiday-schedule)
	- weekday : day of the week
	- workingday : if day is neither weekend nor holiday is 1, otherwise is 0.
	+ weathersit : 
		- 1: Clear, Few clouds, Partly cloudy, Partly cloudy
		- 2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
		- 3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
		- 4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog
	- temp : Normalized temperature in Celsius. The values are divided to 41 (max)
	- atemp: Normalized feeling temperature in Celsius. The values are divided to 50 (max)
	- hum: Normalized humidity. The values are divided to 100 (max)
	- windspeed: Normalized wind speed. The values are divided to 67 (max)
	- casual: count of casual users
	- registered: count of registered users
	- cnt: count of total rental bikes including both casual and registered
	


##Fonti:

[1] Fanaee-T, Hadi, and Gama, Joao, "Event labeling combining ensemble detectors and background knowledge", Progress in Artificial Intelligence (2013): pp. 1-15, Springer Berlin Heidelberg, doi:10.1007/s13748-013-0040-3.

https://data.world/data-society/capital-bikeshare-2011-2012 (day.csv)

=========================================

#Analisi

Importiamo i pacchetti necessari:
```{r}
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(ggridges)
library(broom)
library(ggpubr)
library(dplyr)
library(reshape2)
library(plotly)
library(zoo)
```


Carichiamo il file:
```{r}
day <- read.csv('C:/Users/user/Documents/RStudio repository/uci-bike-sharing-dataset/day.csv')
```


Formattiamo una tabella per dare un'occhiata alle prime righe del dataset:
```{r}
head<-day %>% 
  head() %>% 
  kable(escape = F,
        caption = "<b>Tabella 1.</b> Estratto delle prime sei righe del data frame `day` in formato `tibble`.") %>%
  kable_paper(full_width = F)
head
```


Cambiamo il formato della colonna dteday da stringa a data:
```{r}
bsh <- day %>%
  mutate(dteday = as.Date(dteday, format="%Y-%m-%d"), temp = temp*41)

#bsh$dteday <- as.Date(bsh$dteday, format="%Y-%m-%d")
```


Cerchiamo di coprendere la distribuzione di aclune variabili:
```{r}
sommario <- bsh %>%
  select(dteday, holiday, weathersit, temp, atemp, hum,  windspeed, casual, registered, cnt)
summary(sommario)
```


Controlliamo che cnt sia la somma di casual e registered:
```{r}
all(bsh$casual + bsh$registered == bsh$cnt)
```


Estraiamo qualche informazione in più su alcune variabili di interesse:
```{r}
variabilita_conto <- bsh %>% 
  summarise(
    media_tot = mean(cnt, na.rm=T),
    varianza_tot = var(cnt, na.rm = T), 
    dev_std_tot = sd(cnt, na.rm = T),
    cv_tot = (dev_std_tot/media_tot),
    IQR_tot = IQR(cnt, na.rm = T),
    media_reg = mean(registered, na.rm=T),
    varianza_reg = var(registered, na.rm = T), 
    dev_std_reg = sd(registered, na.rm = T),
    cv_reg = (dev_std_reg/media_reg),
    IQR_reg = IQR(registered, na.rm = T),
    media_nreg = mean(casual, na.rm=T),
    varianza_nreg = var(casual, na.rm = T), 
    dev_std_nreg = sd(casual, na.rm = T),
    cv_nreg = (dev_std_nreg/media_nreg),
    IQR_nreg = IQR(casual, na.rm = T),
    media_temp = mean(temp, na.rm=T),
    varianza_temp = var(temp, na.rm = T), 
    dev_std_temp = sd(temp, na.rm = T),
    cv_temp = (dev_std_temp/media_temp),
    IQR_temp = IQR(temp, na.rm = T),
  )%>%
    kable(escape = F,
          caption = "<b>Tabella 1.</b> Distribuzione e variabilità`.") %>%
    kable_styling(bootstrap_options = "hover", full_width = F) %>%
    add_header_above(header = c("Misure statistiche totale noleggi" = 5, "Misure statistiche noleggi utenti registrati" = 5, "Misure statistiche noleggi utenti non registrati" = 5, "Misure statistiche temperature" = 5), italic = T)

variabilita_conto

```
Il coefficiente di variazione è meggiore per i noleggi di utenti non registrati, probabilmente in quanto meno spinti a noleggiare regolarmente.


Visualizziamo la distribuzione della temperatura per mese:
```{r}
bsh$monthyear <- as.yearmon(bsh$dteday, "%b %Y")

ggplot(bsh, aes(x = temp, y=monthyear, group=monthyear, fill = stat(x))) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_fill_viridis_c(name = "Temp.", option = "C") +
  coord_cartesian(clip = "off") +
  labs(x="Temperatura normalizzata", title = 'Temperature a Washington D.C. in 2011-2012') +
  theme(axis.title.y = element_blank())
```


Visualizziamo la distribuzione del totale di biciclette noleggiate per anno (0=2011, 1=2012):
```{r}
ggplot(data = bsh, aes(x = yr, y = cnt, group = yr)) + 
  geom_boxplot(fill = "darkorange", alpha=0.1, coef = 10) + 
  geom_jitter(width = 0, height = 0, alpha = 0.1, col = "black") +
  stat_summary(fun = "mean", geom = "point", col = "darkorange", pch = 18, size = 4) +
  labs(x="Anno", y = "Biciclette noleggiate", title = "Distribuzione biciclette noleggiate annualmente")+
  scale_x_continuous(breaks = 0:2)+
  theme_bw()
```


Visualizziamo la distribuzione del totale di biciclette noleggiate mensilmente:
```{r}
ggplot(data = bsh, aes(x = mnth, y = cnt, group = mnth)) + 
  geom_boxplot(fill = "darkorange", alpha=0.1, coef = 10) + 
  geom_jitter(width = 0, height = 0, alpha = 0.2, col = "black") +
  stat_summary(fun = "mean", geom = "point", col = "darkorange", pch = 18, size = 4) + 
  labs(x="Mese", y = "Biciclette noleggiate", title = "Distribuzione biciclette noleggiate mensilmente")+
  scale_x_continuous(breaks = 1:12)+
  theme_bw()
```


Visualizziamo la distribuzione del totale di biciclette noleggiate per giorno della settimana, 0=Domenica, 1=Lunedì:
```{r}
ggplot(data = bsh, aes(x = weekday, y = cnt, group = weekday)) + 
  geom_boxplot(fill = "darkorange", alpha=0.1, coef = 10) + 
  geom_jitter(width = 0, height = 0, alpha = 0.2, col = "black", size=2) +
  stat_summary(fun = "mean", geom = "point", col = "darkorange", pch = 18, size = 4) + 
  labs(x = "Giorno della settimana", y = "Biciclette noleggiate", title = "Distribuzione biciclette noleggiate per giorno della settimana") +
  scale_x_continuous(breaks = 0:12)+
  theme_bw()
```


Calcoliamo la temperatura media mensile e le percentuale di biciclette noleggiate per mese da i diversi gruppi di utenti:
```{r}
bsharing <- bsh %>%
  mutate(mese = mnth,
         tot_affitti = sum(cnt), 
         tot_registrati = sum(registered), 
         tot_non_registrati = sum(casual)) %>% 
  group_by(mese) %>%
  summarise(aggr_mese_noleggi = sum(cnt), 
            aggr_mese_registrati = sum(registered),
            aggr_mese_non_registrati = sum(casual),
            media_temp = mean(temp)) %>%
  mutate(tot_noleggi = sum(aggr_mese_noleggi), 
         perc_tot_noleggi = aggr_mese_noleggi/tot_noleggi*100,
         tot_registrati = sum(aggr_mese_registrati), 
         perc_registrati = aggr_mese_registrati/tot_registrati*100,
         tot_non_registrati = sum(aggr_mese_non_registrati), 
         perc_non_registrati = aggr_mese_non_registrati/tot_non_registrati*100) %>%
  summarise(mese, media_temp, perc_tot_noleggi, perc_registrati, perc_non_registrati)

bsharing
```


Visualizziamo la variazione del conto delle biciclette noleggiate dalle diverse categorie di utenti e la media della temperatura (adattata per essere visualizzata al meglio) per settimana:
```{r}
weekly <- bsh %>%
  mutate(Week = as.Date(cut(dteday, breaks = "week")))%>%
  group_by(Week) %>%
  summarise('Noleggi non registrati' = sum(casual), 'Noleggi registrati' = sum(registered)) %>%
  gather(key = "Serie", value = "value", -Week)


ggplot(data = weekly) +
  geom_rect(data= bsh, aes(xmin=dteday-10,xmax=dteday+10,ymin=Inf,ymax=-Inf, 
      fill=temp)) +
  scale_fill_viridis_c(name = "Temp.", option = "C") +
  geom_line(aes(x = Week, y = value, color = Serie, linetype = Serie), size = 1) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "2 month", expand = c(0, 0)) +
  theme(axis.text.x = element_text(angle =45, hjust = 1)) +
  scale_linetype_manual(values=c("dashed", "solid")) +
  scale_color_manual(values=c('black', 'black')) +
  labs(x = "Settimana", y = "Biciclette noleggiate", title = "Serie temporale biciclette noleggiate settimanalmente")

```
Queste sembrano correlate in quanto con l'innalzamento della temperatura si nota una conseguente variazione positiva del numeto di noleggi.


Proviamo a svolgere una regressione per vedere se la variabile conto delle biciclette affittate è correlata alla temperatura e quanto questa correlazione sia forte.


Controlliamo se vi è linearità nella relazione fra le variabili:
```{r}
ggplot(data = bsh, mapping = aes(x = temp, y = cnt), color=black) + 
  geom_point(alpha = 0.5) +
  stat_smooth(color = "darkorange", fill = "darkorange", method = "loess") +
  theme_bw()
```
Vi è una certa linearità fino al valore temp 0.6, che rappresenta i 24.6 gradi Celsius, ma oltre questa soglia la relazione fra le variabili tende a curvarsi.


tutto:
```{r}
plot(bsh$temp, bsh$cnt)
retta=lm(bsh$cnt ~ bsh$temp)
abline(retta, col="blue")
segments(bsh$temp, fitted(retta), bsh$temp, bsh$cnt, lty=2)
title(main="Regressione fra conto e temperatura")

plot(retta)
summary(retta)

```


modello parabolico
```{r}
plot(bsh$temp, bsh$cnt)
temp2 = bsh$temp^2
parabola = lm(bsh$cnt ~ bsh$temp + temp2)
lines(bsh$temp, fitted(parabola), lwd = 3)
title(main="Regressione parabola fra conto e temperatura")

plot(parabola)
summary(parabola)
```


2012:
```{r}
d2012 <- bsh %>%
  filter(yr==1)
plot(d2012$temp, d2012$cnt)
temp2012 = d2012$temp^2
parabola2012 = lm(d2012$cnt ~ d2012$temp + temp2012)
lines(d2012$temp, fitted(parabola2012), lwd = 3)
title(main="Regressione parabola fra conto e temperatura")

plot(parabola2012)
summary(parabola2012)

```


2011:
```{r}
d2011 <- bsh %>%
  filter(yr==0)
plot(d2011$temp, d2011$cnt)
temp2011 = d2011$temp^2
parabola2011 = lm(d2011$cnt ~ d2011$temp + temp2011)
lines(d2011$temp, fitted(parabola2011), lwd = 3)
title(main="Regressione parabola fra conto e temperatura")

plot(parabola2011)
summary(parabola2011)

```


#Conclusioni
Abbiamo esplorato vari pacchetti di r per svolgere questa analisi e provato a costruire vari tipi di visualizzazioni. Questo ci ha permesso di comprendere meglio il dataset.
nell'opinione dell'autore Le tecniche utilizzate non sono le più efficaci per raggiungere gli obbiettivi del progetto ma abbiamo comunque potuto notare che vi è una certa relazione fra temperature e affitti la regressione non ha dato buoni risultati in quanto non sia il modello adatto al dataset.